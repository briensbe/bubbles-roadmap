<div class="roadmap-container">
  <!-- 1. FIXED HEADER -->
  <div class="roadmap-header">
    <h2>Project Roadmap Bubble Chart</h2>

    <div class="roadmap-controls">
      <!-- Navigation -->
      <div class="timeline-nav">
        <!-- Chevron Left -->
        <button class="nav-btn icon-btn" (click)="navigate(-12)">
          <lucide-icon [img]="ChevronLeft" [size]="20"></lucide-icon>
        </button>

        <!-- Dynamic Year Indicators (N-1, N, N+1) -->
        <div class="year-indicators">
          @for (year of navigationYears(); track year) {
          <button
            class="year-badge"
            [class.active]="year === currentYear()"
            (click)="jumpToYear(year)"
          >
            <span class="year-label">{{ year }}</span>
            <span class="count-pill">{{ getProjectCount(year) }}</span>
          </button>
          }
        </div>

        <!-- Chevron Right -->
        <button class="nav-btn icon-btn" (click)="navigate(12)">
          <lucide-icon [img]="ChevronRight" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="search-container">
        <lucide-icon [img]="Search" [size]="18" class="search-icon"></lucide-icon>
        <input
          type="text"
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          placeholder="Filtrer les projets..."
          class="search-input"
        />
      </div>

      <button class="nav-btn btn-add" (click)="openAddModal()">
        <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
        <span>Add project</span>
      </button>
    </div>
  </div>

  <!-- 2. MAIN CHART AREA (Flex layout) -->
  <div class="main-chart-area">
    <!-- Left: Fixed Y-Axis column -->
    <div class="y-axis-container">
      <div class="axis-y-label">Value (Max {{ CONFIG.MAX_BUSINESS_VALUE }})</div>
      <div class="axis-y">
        @for (i of yAxisTicks; track i) {
        <div class="y-tick" [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100">
          {{ i }}
        </div>
        }
      </div>
    </div>

    <!-- Right: Scrollable Grid & X-Axis -->
    <div class="scrollable-content">
      <div class="roadmap-grid" (click)="deselectProject()">
        <!-- Grid Lines Y -->
        @for (i of yAxisTicks; track i) { @if (i > 0) {
        <div class="grid-line-y" [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100"></div>
        } }

        <!-- Grid Lines X and X-Axis (Timeline) -->
        @for (month of timelineMonths; track month.name + month.year; let i = $index) {
        <div class="grid-line-x" [style.left.%]="(i + 1) * (100 / viewDurationMonths)"></div>
        }

        <div class="axis-x">
          @for (month of timelineMonths; track month.name + month.year) {
          <div class="month-label">
            <span class="month-name">{{ month.name }}</span>
            <span class="month-year">{{ month.year }}</span>
          </div>
          }
        </div>

        <!-- Bubbles (Clipped in a viewport) -->
        <div class="bubbles-viewport">
          @for (project of visibleProjects(); track project.id) {
          <app-project-bubble
            [project]="project"
            [isSelected]="activeProject()?.id === project.id"
            [initialX]="calculateXPosition(project.startDate)"
            [initialY]="calculateYPosition(project.value)"
            [lockXAxis]="isXAxisLocked()"
            [showLabelsOnHoverOnly]="showLabelsOnHoverOnly()"
            [style.position]="'absolute'"
            [style.left.px]="calculateXPosition(project.startDate)"
            [style.bottom.px]="calculateYPosition(project.value)"
            [style.z-index]="topmostProjectId() === project.id ? 100 : 10"
            (hovered)="topmostProjectId.set(project.id)"
            (clickSelection)="selectProject($event)"
            (edit)="openEditModal(project)"
            (positionChange)="handlePositionChange($event)"
            (complexityChange)="handleComplexityChange($event)"
          ></app-project-bubble>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- 3. FIXED LEGENDS -->
  <div class="fixed-legends">
    <div class="complexity-legend">
      <h4>Complexity (Size) Legend</h4>
      <div class="legend-items-container">
        @for (item of complexityLegend; track item.label) {
        <div class="legend-item">
          <div
            class="legend-bubble"
            [style.width.px]="getLegendBubbleSize(item.size)"
            [style.height.px]="getLegendBubbleSize(item.size)"
          ></div>
          <span>{{ item.label }}</span>
          <span>{{ item.description }}</span>
          <span>{{ item.range[0] }} - {{ item.range[1] }}</span>
        </div>
        }
      </div>
    </div>

    <div class="complexity-legend">
      <h4>Service Legend (Color)</h4>
      <div class="legend-items-container service-legend-container">
        @for (service of visibleServices(); track service) {
        <div class="legend-item service-legend-item">
          <div
            class="legend-bubble"
            [style.background-color]="roadmapService.getServiceColor(service)"
            [style.width.px]="16"
            [style.height.px]="16"
          ></div>
          <span>{{ service }}</span>
        </div>
        } @if (visibleServiceCount() < roadmapService.distinctServices().length) {
        <button class="show-more-btn" (click)="$event.stopPropagation(); showMoreServices()">
          Afficher plus (+{{
            Math.min(3, roadmapService.distinctServices().length - visibleServiceCount())
          }})
        </button>
        }
      </div>
    </div>

    <div class="complexity-legend">
      <h4>Options</h4>
      <div class="legend-items-container">
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="showLabelsOnHoverOnly()"
            (change)="showLabelsOnHoverOnly.set(!showLabelsOnHoverOnly())"
          />
          <span class="slider"></span>
          <span class="toggle-label">Labels au survol uniquement</span>
        </label>
      </div>
      <div class="legend-items-container">
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="isXAxisLocked()"
            (change)="isXAxisLocked.set(!isXAxisLocked())"
          />
          <span class="slider"></span>
          <span class="toggle-label">Lock Project Dates (x-axis)</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  @if (editingProject()) {
  <app-project-edit-modal
    [project]="editingProject()!"
    (close)="closeEditModal()"
  ></app-project-edit-modal>
  }
</div>
