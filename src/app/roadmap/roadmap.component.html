<div class="roadmap-container">
  <div class="roadmap-header">
    <h2>Project Roadmap Bubble Chart</h2>

    <div class="roadmap-controls">
      <label class="toggle-switch">
        <input
          type="checkbox"
          [checked]="isXAxisLocked()"
          (change)="isXAxisLocked.set(!isXAxisLocked())"
        />
        <span class="slider"></span>
        <span class="toggle-label">ðŸ”’ Lock Timeline (X-Axis)</span>
      </label>
    </div>
  </div>

  <div class="roadmap-grid" (click)="deselectProject()">
    <!-- Y-Axis (Value) -->
    <div class="axis-y-label">
      Value (Max {{ CONFIG.MAX_BUSINESS_VALUE }} / Scale {{ CONFIG.VALUE_RANGE }})
    </div>
    <div class="axis-y">
      @for (i of yAxisTicks; track i) {
      <div [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100">
        {{ i }}
      </div>
      }
    </div>

    <!-- Grid Lines Y -->
    @for (i of yAxisTicks; track i) { @if (i > 0) {
    <div class="grid-line-y" [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100"></div>
    } }

    <!-- Grid Lines X and X-Axis (Timeline) -->
    @for (month of months; track month; let i = $index) {
    <div class="grid-line-x" [style.left.%]="(i + 1) * (100 / 12)"></div>
    }
    <div class="axis-x">
      @for (month of months; track month) {
      <div class="month-label">{{ month }}</div>
      }
    </div>

    <!-- Bubbles -->
    @for (project of projects(); track project.id) {
    <app-project-bubble
      [project]="project"
      [isSelected]="activeProject()?.id === project.id"
      [initialX]="calculateXPosition(project.startDate)"
      [initialY]="calculateYPosition(project.value)"
      [lockXAxis]="isXAxisLocked()"
      [style.position]="'absolute'"
      [style.left.px]="calculateXPosition(project.startDate)"
      [style.bottom.px]="calculateYPosition(project.value)"
      [style.z-index]="topmostProjectId() === project.id ? 100 : 10"
      (hovered)="topmostProjectId.set(project.id)"
      (clickSelection)="selectProject($event)"
      (edit)="openEditModal(project)"
      (positionChange)="handlePositionChange($event)"
      (complexityChange)="handleComplexityChange($event)"
    ></app-project-bubble>
    }
  </div>

  <!-- Legends -->
  <div style="display: flex; justify-content: center; margin-top: 50px; align-items: flex-start">
    <div class="complexity-legend">
      <h4>Complexity (Size) Legend</h4>
      <div class="legend-items-container">
        @for (item of complexityLegend; track item.label) {
        <div class="legend-item">
          <div
            class="legend-bubble"
            [style.width.px]="getLegendBubbleSize(item.size)"
            [style.height.px]="getLegendBubbleSize(item.size)"
          ></div>
          <span>{{ item.label }}</span>
          <span>{{ item.description }}</span>
          <span>{{ item.range[0] }} - {{ item.range[1] }}</span>
        </div>
        }
      </div>
    </div>

    <div class="complexity-legend">
      <h4>Service (Color) Legend</h4>
      <div class="legend-items-container">
        @for (service of serviceColors; track service.name) {
        <div class="legend-item">
          <div
            class="legend-bubble"
            [ngClass]="service.class"
            [style.width.px]="20"
            [style.height.px]="20"
          ></div>
          <span>{{ service.name }}</span>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
@if (editingProject()) {
<app-project-edit-modal
  [project]="editingProject()!"
  (close)="closeEditModal()"
></app-project-edit-modal>
}
