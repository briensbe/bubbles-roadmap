<div class="roadmap-container">
  <!-- 1. FIXED HEADER -->
  <div class="roadmap-header">
    <h2>Project Roadmap Bubble Chart</h2>

    <div class="roadmap-controls">
      <!-- Navigation -->
      <div class="timeline-nav">
        <!-- Chevron Left -->
        <button class="nav-btn icon-btn" (click)="navigate(-12)">
          <lucide-icon [img]="ChevronLeft" [size]="20"></lucide-icon>
        </button>

        <!-- Dynamic Year Indicators (N-1, N, N+1) -->
        <div class="year-indicators">
          @for (year of navigationYears(); track year) {
          <button
            class="year-badge"
            [class.active]="year === currentYear()"
            (click)="jumpToYear(year)"
          >
            <span class="year-label">{{ year }}</span>
            <span class="count-pill">{{ getProjectCount(year) }}</span>
          </button>
          }
        </div>

        <!-- Chevron Right -->
        <button class="nav-btn icon-btn" (click)="navigate(12)">
          <lucide-icon [img]="ChevronRight" [size]="20"></lucide-icon>
        </button>
      </div>

      <div class="search-container">
        <lucide-icon [img]="Search" [size]="18" class="search-icon"></lucide-icon>
        <input
          type="text"
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          placeholder="Filtrer les projets..."
          class="search-input"
        />
      </div>

      <button class="nav-btn btn-add" (click)="openAddModal()">
        <lucide-icon [img]="Plus" [size]="20"></lucide-icon>
        <span>Add project</span>
      </button>
    </div>
  </div>

  <!-- 2. MAIN CHART AREA (Flex layout) -->
  <div class="main-chart-area">
    <!-- Left: Fixed Y-Axis column -->
    <div class="y-axis-container">
      <app-value-brush
        [min]="0"
        [max]="CONFIG.VALUE_RANGE"
        [activeMin]="viewMinValue()"
        [activeMax]="viewMaxValue()"
        (rangeChange)="handleValueRangeChange($event)"
      ></app-value-brush>
      <div class="axis-y-label">Value (Max {{ CONFIG.MAX_BUSINESS_VALUE }})</div>
      <div class="axis-y">
        @for (i of yAxisTicks; track i) {
        <div class="y-tick" [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100">
          {{ i }}
        </div>
        }
      </div>
    </div>

    <!-- Right: Scrollable Grid & X-Axis -->
    <div class="scrollable-content">
      <div class="roadmap-grid" #gridContainer (click)="deselectProject()">
        <!-- Grid Lines Y -->
        @for (i of yAxisTicks; track i) { @if (i > 0) {
        <div class="grid-line-y" [style.bottom.%]="(i / CONFIG.VALUE_RANGE) * 100"></div>
        } }

        <!-- Grid Lines X and X-Axis (Timeline) -->
        @for (month of timelineMonths; track month.name + month.year) {
        <div class="grid-line-x" [style.left.%]="month.leftPercent"></div>
        }

        <div class="axis-x">
          @for (month of timelineMonths; track month.name + month.year) {
          <div
            class="month-label"
            [style.left.%]="month.leftPercent"
            style="position: absolute; transform: translateX(5px)"
          >
            <span class="month-name">{{ month.name }}</span>
            <span class="month-year">{{ month.year }}</span>
          </div>
          }
        </div>

        <!-- Bubbles (Clipped in a viewport) -->
        <div class="bubbles-viewport">
          @for (project of visibleProjects(); track project.id) {
          <app-project-bubble
            [project]="project"
            [isSelected]="activeProject()?.id === project.id"
            [initialX]="calculateXPositionPixels(project.startDate)"
            [initialY]="calculateYPosition(project.value)"
            [lockXAxis]="isXAxisLocked()"
            [showLabelsOnHoverOnly]="showLabelsOnHoverOnly()"
            [style.position]="'absolute'"
            [style.left.px]="calculateXPositionPixels(project.startDate)"
            [style.bottom.px]="calculateYPosition(project.value)"
            [style.z-index]="topmostProjectId() === project.id ? 100 : 10"
            (hovered)="topmostProjectId.set(project.id)"
            (clickSelection)="selectProject($event)"
            (edit)="openEditModal(project)"
            (positionChange)="handlePositionChange($event)"
            (complexityChange)="handleComplexityChange($event)"
          ></app-project-bubble>
          }
        </div>
      </div>

      <!-- TIMELINE BRUSH CONTROL -->
      <app-timeline-brush
        [globalStartDate]="globalStartDate()"
        [globalEndDate]="globalEndDate()"
        [activeStartDate]="viewStartDate()"
        [activeEndDate]="viewEndDate()"
        (rangeChange)="handleRangeChange($event)"
      ></app-timeline-brush>
    </div>
  </div>

  <!-- 3. INTERACTIVE FILTERS -->
  <div class="fixed-legends">
    <!-- Header with count and controls -->
    <div class="filters-header">
      <h4>
        Filtres <span class="project-count">({{ filteredProjectCount() }} projets)</span>
      </h4>
      <button class="clear-all-btn" (click)="selectAllFilters()">Tout sélectionner</button>
    </div>
    <!-- Complexity Filters -->
    <div class="filter-section">
      <h5>Complexité</h5>
      <div class="filter-badges-container">
        @for (item of complexityLegend; track item.label) {
        <button
          class="filter-badge complexity-badge"
          [class.active]="isComplexityFilterActive(item.label)"
          (click)="toggleComplexityFilter(item.label)"
        >
          <div
            class="badge-bubble"
            [style.width.px]="getLegendBubbleSize(item.size) * 0.5"
            [style.height.px]="getLegendBubbleSize(item.size) * 0.5"
          ></div>
          <span class="badge-label">{{ item.label }}</span>
          <span class="badge-range">{{ item.range[0] }}-{{ item.range[1] }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Service Filters -->
    <div class="filter-section">
      <h5>Services</h5>
      <div class="filter-badges-container service-badges">
        @for (service of visibleServices(); track service) {
        <button
          class="filter-badge service-badge"
          [class.active]="isServiceFilterActive(service)"
          [style.--service-color]="roadmapService.getServiceColor(service)"
          (click)="toggleServiceFilter(service)"
        >
          <div class="service-color-dot"></div>
          <span class="badge-label">{{ service }}</span>
        </button>
        } @if (visibleServiceCount() < roadmapService.distinctServices().length) {
        <button class="show-more-btn" (click)="$event.stopPropagation(); showMoreServices()">
          Afficher plus (+{{
            Math.min(3, roadmapService.distinctServices().length - visibleServiceCount())
          }})
        </button>
        }
      </div>
    </div>

    <!-- Options Section -->
    <div class="filter-section">
      <h5>Options</h5>
      <div class="legend-items-container">
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="showLabelsOnHoverOnly()"
            (change)="showLabelsOnHoverOnly.set(!showLabelsOnHoverOnly())"
          />
          <span class="slider"></span>
          <span class="toggle-label">Labels au survol uniquement</span>
        </label>
      </div>
      <div class="legend-items-container">
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="isXAxisLocked()"
            (change)="isXAxisLocked.set(!isXAxisLocked())"
          />
          <span class="slider"></span>
          <span class="toggle-label">Lock Project Dates (x-axis)</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  @if (editingProject()) {
  <app-project-edit-modal
    [project]="editingProject()!"
    (close)="closeEditModal()"
  ></app-project-edit-modal>
  }
</div>
